define(["datetime","imageLoader","connectionManager","itemHelper","focusManager","indicators","globalize","layoutManager","apphost","dom","browser","playbackManager","itemShortcuts","humanedate","css!./card","paper-icon-button-light","programStyles","embyProgressBarStyle","emby-checkbox","emby-playstatebutton","emby-ratingbutton"],function(datetime,imageLoader,connectionManager,itemHelper,focusManager,indicators,globalize,layoutManager,appHost,dom,browser,playbackManager,itemShortcuts,humanedate){"use strict";window.devicePixelRatio;var enableFocusTransfrom=!browser.slow&&!browser.edge;var cachedWidths={};function getImageWidth(shape,screenWidth){var shapeWidth=screenWidth/(screenWidth/function(shape,screenWidth){var key=shape+screenWidth,width=cachedWidths[key];if(width)return width;var div=document.createElement("div");div.className="itemsContainer",layoutManager.tv&&div.classList.add("itemsContainer-tv"),div.style.visibility="hidden",div.innerHTML='<div class="card '+shape+'Card"><div class="cardBox"><div class="cardScalable"></div></div></div>';var parent=document.body;return parent.appendChild(div),width=cachedWidths[key]=div.querySelector(".cardScalable").offsetWidth,parent.removeChild(div),width}(shape,screenWidth));return Math.round(shapeWidth)}function setCardData(items,options){options.shape=options.shape||"auto";var primaryImageAspectRatio=imageLoader.getPrimaryImageAspectRatio(items);if("auto"===options.shape||"autohome"===options.shape||"autooverflow"===options.shape||"autoVertical"===options.shape){var requestedShape=options.shape;options.shape=null,primaryImageAspectRatio&&(options.shape=3<=primaryImageAspectRatio?"banner":1.4<=primaryImageAspectRatio?"autooverflow"===requestedShape?"overflowBackdrop":"backdrop":1.2<primaryImageAspectRatio?"autooverflow"===requestedShape?"overflowFourThree":"fourThree":.71<primaryImageAspectRatio?"autooverflow"===requestedShape?"overflowSquare":"square":"autooverflow"===requestedShape?"overflowPortrait":"portrait"),options.shape||(options.shape=options.defaultShape||function(items,requestedShape){var firstItem=items[0];if(firstItem)switch(firstItem.Type){case"Movie":case"SeriesTimer":return"autooverflow"===requestedShape?"overflowPortrait":"portrait";case"Episode":case"Program":case"Video":return"autooverflow"===requestedShape?"overflowBackdrop":"backdrop"}return"autooverflow"===requestedShape?"overflowSquare":"square"}(items,requestedShape))}if("auto"===options.preferThumb&&(options.preferThumb="backdrop"===options.shape||"overflowBackdrop"===options.shape),options.uiAspect=getDesiredAspect(options.shape),options.primaryImageAspectRatio=primaryImageAspectRatio,!options.width&&options.widths&&(options.width=options.widths[options.shape]),options.rows&&"number"!=typeof options.rows&&(options.rows=options.rows[options.shape]),!options.width){var screenWidth=dom.getWindowSize().innerWidth;if(function(windowWidth){var screen=window.screen;return!!(screen&&20<screen.availWidth-windowWidth)}(screenWidth)){screenWidth=100*Math.floor(screenWidth/100)}options.width=getImageWidth(options.shape,screenWidth)}}function buildCardsHtmlInternal(items,options){options.shape,setCardData(items,options);var hasOpenRow,apiClient,lastServerId,i,length,html="",itemsInRow=0,uiAspect=(options.sectionTitleTagName,getDesiredAspect(options.shape));for(i=0,length=items.length;i<length;i++){var item=items[i],serverId=item.ServerId||options.serverId;serverId!==lastServerId&&(lastServerId=serverId,apiClient=connectionManager.getApiClient(lastServerId)),options.rows&&0===itemsInRow&&(hasOpenRow&&(html+="</div>",hasOpenRow=!1),html+='<div class="cardColumn">',hasOpenRow=!0),html+=buildCard(i,item,apiClient,options,uiAspect),itemsInRow++,options.rows&&itemsInRow>=options.rows&&(html+="</div>",hasOpenRow=!1,itemsInRow=0)}hasOpenRow&&(html+="</div>");var cardFooterHtml="";for(i=0,length=options.lines||0;i<length;i++)cardFooterHtml+=0===i?'<div class="cardText cardTextCentered cardText-first">&nbsp;</div>':'<div class="cardText cardTextCentered cardText-secondary">&nbsp;</div>';return html}function getDesiredAspect(shape){if(shape){if(-1!==(shape=shape.toLowerCase()).indexOf("portrait"))return 2/3;if(-1!==shape.indexOf("backdrop"))return 16/9;if(-1!==shape.indexOf("square"))return 1;if(-1!==shape.indexOf("fourthree"))return 4/3;if(-1!==shape.indexOf("banner"))return 1e3/185}return null}var refreshIndicatorLoaded,numRandomColors=5;function getDefaultColorIndex(str){if(str){for(var charIndex=Math.floor(str.length/2),character=String(str.substr(charIndex,1).charCodeAt()),sum=0,i=0;i<character.length;i++)sum+=parseInt(character.charAt(i));return String(sum).substr(-1)%numRandomColors+1}return function(min,max){return Math.floor(Math.random()*(max-min+1))+min}(1,numRandomColors)}function isUsingLiveTvNaming(itemType){return"Program"===itemType||"Timer"===itemType||"Recording"===itemType}function getAirTimeText(item,showAirDateTime,showAirEndTime){var airTimeText="";if(item.StartDate)try{var date=datetime.parseISO8601Date(item.StartDate);showAirDateTime&&(airTimeText+=datetime.toLocaleDateString(date,{weekday:"short",month:"short",day:"numeric"})+" "),airTimeText+=datetime.getDisplayTime(date),item.EndDate&&showAirEndTime&&(date=datetime.parseISO8601Date(item.EndDate),airTimeText+=" &ndash; "+datetime.getDisplayTime(date))}catch(e){console.log("Error parsing date: "+item.StartDate)}return airTimeText}function getCardFooterText(item,apiClient,options,showTitle,forceName,overlayText,imgUrl,footerClass,progressHtml,logoUrl,isOuterFooter){var itemType=item.Type,html="";logoUrl&&(html+='<div class="lazy cardFooterLogo" loading="lazy" style="background-image:url('+logoUrl+');"></div>');var showOtherText=isOuterFooter?!overlayText:overlayText;isOuterFooter&&options.cardLayout&&!layoutManager.tv&&!1!==options.cardFooterAside&&(html+='<button is="paper-icon-button-light" class="itemAction btnCardOptions cardText-secondary" data-action="menu"><i class="md-icon">&#xE5D3;</i></button>');var titleAdded,cssClass=options.centerText?"cardText cardTextCentered":"cardText",lines=[],parentTitleUnderneath="MusicAlbum"===itemType||"Audio"===itemType||"MusicVideo"===itemType||"Game"===itemType,serverId=item.ServerId||options.serverId;if(showOtherText&&(options.showParentTitle||options.showParentTitleOrTitle)&&!parentTitleUnderneath)if(isOuterFooter&&"Episode"===itemType&&item.SeriesName)item.SeriesId?lines.push(getTextActionButton({Id:item.SeriesId,ServerId:serverId,Name:item.SeriesName,Type:"Series",IsFolder:!0})):lines.push(dom.htmlEncode(item.SeriesName));else if(isUsingLiveTvNaming(itemType))lines.push(dom.htmlEncode(item.Name)),item.EpisodeTitle||(titleAdded=!0);else{var parentTitle=item.SeriesName||item.Series||item.Album||item.AlbumArtist||item.GameSystem||"";(parentTitle||showTitle)&&lines.push(dom.htmlEncode(parentTitle))}var showMediaTitle=showTitle&&!titleAdded||options.showParentTitleOrTitle&&!lines.length;if(showMediaTitle||titleAdded||!showTitle&&!forceName||(showMediaTitle=!0),showMediaTitle){var name="auto"!==options.showTitle||item.IsFolder||"Photo"!==item.MediaType?itemHelper.getDisplayName(item,{includeParentInfo:options.includeParentInfoInTitle}):"";overlayText?lines.push(dom.htmlEncode(name)):lines.push(getTextActionButton(item,name,serverId,options.parentId,!0))}if(showOtherText){if(options.showParentTitle&&parentTitleUnderneath&&(isOuterFooter&&item.AlbumArtists&&item.AlbumArtists.length&&"MusicAlbum"===itemType?(item.AlbumArtists[0].Type="MusicArtist",item.AlbumArtists[0].IsFolder=!0,lines.push(getTextActionButton(item.AlbumArtists[0],null,serverId))):isOuterFooter&&item.ArtistItems&&item.ArtistItems.length?(item.ArtistItems[0].Type="MusicArtist",item.ArtistItems[0].IsFolder=!0,lines.push(getTextActionButton(item.ArtistItems[0],null,serverId))):isOuterFooter&&item.AlbumArtists&&item.AlbumArtists.length?(item.AlbumArtists[0].Type="MusicArtist",item.AlbumArtists[0].IsFolder=!0,lines.push(getTextActionButton(item.AlbumArtists[0],null,serverId))):isOuterFooter&&item.GameSystem&&item.GameSystemId?lines.push(getTextActionButton({Id:item.GameSystemId,ServerId:serverId,Name:item.GameSystem,Type:"GameSystem",IsFolder:!0})):lines.push(dom.htmlEncode(isUsingLiveTvNaming(itemType)?item.Name:item.SeriesName||item.Series||item.Album||item.AlbumArtist||item.GameSystem||""))),options.textLines)for(var additionalLines=options.textLines(item),i=0,length=additionalLines.length;i<length;i++)lines.push(additionalLines[i]);if(options.showYear)if("Series"===itemType)if("Continuing"===item.Status)lines.push(globalize.translate("SeriesYearToPresent",item.ProductionYear||""));else{var endYear=item.EndDate?datetime.parseISO8601Date(item.EndDate).getFullYear():null;endYear&&item.ProductionYear&&endYear!==item.ProductionYear?lines.push(item.ProductionYear+" &ndash; "+endYear):lines.push(item.ProductionYear||"")}else lines.push(item.ProductionYear||"");if(options.showRuntime&&(item.RunTimeTicks?lines.push(datetime.getDisplayRunningTime(item.RunTimeTicks)):lines.push("")),options.showAirTime&&lines.push(getAirTimeText(item,options.showAirDateTime,options.showAirEndTime)||""),options.showChannelName&&(item.ChannelId?lines.push(getTextActionButton({Id:item.ChannelId,ServerId:serverId,Name:item.ChannelName,Type:"TvChannel",MediaType:item.MediaType,IsFolder:!1},item.ChannelName)):lines.push(item.ChannelName||"&nbsp;")),options.showCurrentProgram&&"TvChannel"===itemType&&(item.CurrentProgram?lines.push(item.CurrentProgram.Name):lines.push("")),options.showCurrentProgramTime&&"TvChannel"===itemType&&(item.CurrentProgram?lines.push(getAirTimeText(item.CurrentProgram,!1,!0)||""):lines.push("")),options.showSeriesTimerTime&&(item.RecordAnyTime?lines.push(globalize.translate("Anytime")):lines.push(datetime.getDisplayTime(item.StartDate))),options.showSeriesTimerChannel&&(item.RecordAnyChannel?lines.push(globalize.translate("AllChannels")):lines.push(item.ChannelName||globalize.translate("OneChannel"))),options.showPersonRoleOrType&&(item.Role?lines.push(globalize.translate("ActorAsRole",item.Role)):itemType?lines.push(globalize.translate(""+itemType)):lines.push("")),options.showChapterTime&&lines.push(datetime.getDisplayRunningTime(item.StartPositionTicks)),options.showUserLastSeen&&(item.Policy.IsDisabled?lines.push(globalize.translate("Disabled")):lines.push(item.LastActivityDate?humanedate(item.LastActivityDate):"")),options.showDeviceAppInfo&&lines.push(item.AppName+" "+item.AppVersion),options.showVersion&&lines.push(item.Version||""),options.showDeviceUserInfo){var deviceHtml="";item.LastUserName&&(item.LastUserId?deviceHtml+=getTextActionButton({Id:item.LastUserId,Name:item.LastUserName,ServerId:serverId,Type:"User"},item.LastUserName+", "+humanedate(item.DateLastActivity),null,null,!0):item.LastUserName&&(deviceHtml+=item.LastUserName+", "+humanedate(item.DateLastActivity))),lines.push(deviceHtml)}}(showTitle||!imgUrl)&&forceName&&overlayText&&1===lines.length&&(lines=[]);var addRightTextMargin=isOuterFooter&&options.cardLayout&&!1!==options.cardFooterAside&&!layoutManager.tv;return html+=function(lines,cssClass,forceLines,isOuterFooter,cardLayout,addRightMargin,maxLines){var i,length,html="",valid=0,currentCssClass=cssClass;for(i=0,length=lines.length;i<length;i++){currentCssClass=cssClass;var text=lines[i];if(0<valid&&isOuterFooter?currentCssClass+=" cardText-secondary":0===valid&&isOuterFooter&&(currentCssClass+=" cardText-first"),addRightMargin&&(currentCssClass+=" cardText-rightmargin"),text&&(html+='<div class="'+currentCssClass+'">',html+=text,html+="</div>",valid++,maxLines&&maxLines<=valid))break}if(forceLines)for(length=maxLines||Math.min(lines.length,maxLines||lines.length);valid<length;)currentCssClass=cssClass,0<valid&&isOuterFooter&&(currentCssClass+=" cardText-secondary"),html+='<div class="'+currentCssClass+'">&nbsp;</div>',valid++;return html}(lines,cssClass,!overlayText,isOuterFooter,options.cardLayout,addRightTextMargin,options.lines),progressHtml&&(html+=progressHtml),html&&(isOuterFooter&&!logoUrl&&!options.cardLayout||(html='<div class="'+footerClass+'">'+html,html+="</div>")),html}function getTextActionButton(item,text,serverId,parentId,fullWidth,isSameItemAsCard){if(text=text||itemHelper.getDisplayName(item),layoutManager.tv)return dom.htmlEncode(text);var dataAttributes;text=dom.htmlEncode(text),isSameItemAsCard?dataAttributes="":(dataAttributes=itemShortcuts.getShortcutAttributesHtml(item,serverId),parentId&&(dataAttributes+=' data-parentid="'+parentId+'"'));var html='<button title="'+text+'" '+dataAttributes+' type="button" class="itemAction textActionButton cardTextActionButton" data-action="link">';return html+=text,html+="</button>"}function buildCard(index,item,apiClient,options,uiAspect){var itemType=item.Type,action=options.action||"link";"play"===action&&item.IsFolder?action="link":"Photo"===item.MediaType&&(action="playallfromhere");var shape=options.shape,className="card";shape&&(className+=" "+shape+"Card"),options.cardCssClass&&(className+=" "+options.cardCssClass),options.cardClass&&(className+=" "+options.cardClass);var isLayoutTv=layoutManager.tv;isLayoutTv||(className+=" card-hoverable"),enableFocusTransfrom&&isLayoutTv||(className+=" card-nofocustransform");var imgInfo=function(item,apiClient,options,shape,uiAspect){if(item.ImageUrl)return{imgUrl:item.ImageUrl};item=item.ProgramInfo||item;var width=options.width,height=null,primaryImageAspectRatio=item.PrimaryImageAspectRatio,forceName=!1,imgUrl=null,coverImage=!1,imageTags=item.ImageTags;return options.preferThumb&&imageTags&&imageTags.Thumb?imgUrl=apiClient.getScaledImageUrl(item.Id,{type:"Thumb",maxWidth:width,tag:imageTags.Thumb}):(options.preferBanner||"banner"===shape)&&imageTags&&imageTags.Banner?imgUrl=apiClient.getScaledImageUrl(item.Id,{type:"Banner",maxWidth:width,tag:imageTags.Banner}):options.preferDisc&&imageTags&&imageTags.Disc?imgUrl=apiClient.getScaledImageUrl(item.Id,{type:"Disc",maxWidth:width,tag:imageTags.Disc}):options.preferLogo&&imageTags&&imageTags.Logo?imgUrl=apiClient.getScaledImageUrl(item.Id,{type:"Logo",maxWidth:width,tag:imageTags.Logo}):options.preferLogo&&item.ParentLogoImageTag&&item.ParentLogoItemId?imgUrl=apiClient.getScaledImageUrl(item.ParentLogoItemId,{type:"Logo",maxWidth:width,tag:item.ParentLogoImageTag}):options.preferThumb&&item.ParentThumbItemId&&!1!==options.inheritThumb&&"Photo"!==item.MediaType?imgUrl=apiClient.getScaledImageUrl(item.ParentThumbItemId,{type:"Thumb",maxWidth:width,tag:item.ParentThumbImageTag}):options.preferThumb&&item.BackdropImageTags&&item.BackdropImageTags.length?(imgUrl=apiClient.getScaledImageUrl(item.Id,{type:"Backdrop",maxWidth:width,tag:item.BackdropImageTags[0]}),forceName=!0):options.preferThumb&&item.ParentBackdropImageTags&&item.ParentBackdropImageTags.length&&!1!==options.inheritThumb&&"Episode"===item.Type?imgUrl=apiClient.getScaledImageUrl(item.ParentBackdropItemId,{type:"Backdrop",maxWidth:width,tag:item.ParentBackdropImageTags[0]}):imageTags&&imageTags.Primary?(height=width&&primaryImageAspectRatio?Math.round(width/primaryImageAspectRatio):null,imgUrl=apiClient.getScaledImageUrl(item.Id,{type:"Primary",maxHeight:height,maxWidth:width,tag:imageTags.Primary}),options.preferThumb&&!1!==options.showTitle&&(forceName=!0),primaryImageAspectRatio&&uiAspect&&(coverImage=Math.abs(primaryImageAspectRatio-uiAspect)/uiAspect<=.28)):item.ImageTag&&"Plugin"===item.Type?(imgUrl=apiClient.getUrl("Plugins/"+item.Id+"/Thumb",{maxHeight:height,maxWidth:width,tag:item.ImageTag}),primaryImageAspectRatio&&uiAspect&&(coverImage=Math.abs(primaryImageAspectRatio-uiAspect)/uiAspect<=.28)):item.PrimaryImageTag?(height=width&&primaryImageAspectRatio?Math.round(width/primaryImageAspectRatio):null,"User"===item.Type?imgUrl=apiClient.getUserImageUrl(item.Id,{maxHeight:height,maxWidth:width,tag:item.PrimaryImageTag,type:"Primary"}):(imgUrl=apiClient.getScaledImageUrl(item.PrimaryImageItemId||item.Id||item.ItemId,{type:"Primary",maxHeight:height,maxWidth:width,tag:item.PrimaryImageTag}),options.preferThumb&&!1!==options.showTitle&&(forceName=!0)),primaryImageAspectRatio&&uiAspect&&(coverImage=Math.abs(primaryImageAspectRatio-uiAspect)/uiAspect<=.28)):item.ParentThumbItemId&&!1!==options.inheritThumb&&uiAspect&&1.4<=uiAspect&&"Photo"!==item.MediaType?imgUrl=apiClient.getScaledImageUrl(item.ParentThumbItemId,{type:"Thumb",maxWidth:width,tag:item.ParentThumbImageTag}):item.ParentPrimaryImageTag?imgUrl=apiClient.getScaledImageUrl(item.ParentPrimaryImageItemId,{type:"Primary",maxWidth:width,tag:item.ParentPrimaryImageTag}):item.SeriesPrimaryImageTag?imgUrl=apiClient.getScaledImageUrl(item.SeriesId,{type:"Primary",maxWidth:width,tag:item.SeriesPrimaryImageTag}):item.AlbumId&&item.AlbumPrimaryImageTag?(width=primaryImageAspectRatio?Math.round(height*primaryImageAspectRatio):null,imgUrl=apiClient.getScaledImageUrl(item.AlbumId,{type:"Primary",maxHeight:height,maxWidth:width,tag:item.AlbumPrimaryImageTag}),primaryImageAspectRatio&&uiAspect&&(coverImage=Math.abs(primaryImageAspectRatio-uiAspect)/uiAspect<=.28)):"Season"===item.Type&&imageTags&&imageTags.Thumb?imgUrl=apiClient.getScaledImageUrl(item.Id,{type:"Thumb",maxWidth:width,tag:imageTags.Thumb}):item.BackdropImageTags&&item.BackdropImageTags.length?imgUrl=apiClient.getScaledImageUrl(item.Id,{type:"Backdrop",maxWidth:width,tag:item.BackdropImageTags[0]}):imageTags&&imageTags.Thumb?imgUrl=apiClient.getScaledImageUrl(item.Id,{type:"Thumb",maxWidth:width,tag:imageTags.Thumb}):item.ParentThumbItemId&&!1!==options.inheritThumb?imgUrl=apiClient.getScaledImageUrl(item.ParentThumbItemId,{type:"Thumb",maxWidth:width,tag:item.ParentThumbImageTag}):item.ParentBackdropImageTags&&item.ParentBackdropImageTags.length&&!1!==options.inheritThumb&&(imgUrl=apiClient.getScaledImageUrl(item.ParentBackdropItemId,{type:"Backdrop",maxWidth:width,tag:item.ParentBackdropImageTags[0]})),{imgUrl:imgUrl,forceName:forceName,coverImage:coverImage}}(item,apiClient,options,shape,uiAspect),imgUrl=imgInfo.imgUrl,forceName=imgInfo.forceName,overlayText=options.overlayText;forceName&&!options.cardLayout&&null==overlayText&&(overlayText=!0);var showTitle="auto"===options.showTitle||(options.showTitle||overlayText&&("PhotoAlbum"===itemType||"Folder"===itemType)),cardImageContainerClass="cardImageContainer";(options.coverImage||imgInfo.coverImage)&&(cardImageContainerClass+=" coveredImage","Photo"!==item.MediaType&&"PhotoAlbum"!==itemType&&"Folder"!==itemType&&"Program"!==itemType&&"Recording"!==itemType&&"TvChannel"!==itemType||(cardImageContainerClass+=" coveredImage-noScale")),item.Policy&&item.Policy.IsDisabled&&(cardImageContainerClass+=" grayscaleImage"),options.paddedImage&&(cardImageContainerClass+=" paddedImage"),options.defaultBackground?cardImageContainerClass+=" defaultCardBackground defaultCardBackground0":imgUrl||(cardImageContainerClass+=" "+function(str){return"defaultCardBackground defaultCardBackground"+getDefaultColorIndex(str)}(item.Name));var footerCssClass,cardBoxClass=options.cardLayout?"cardBox visualCardBox":"cardBox";isLayoutTv&&(cardBoxClass+=enableFocusTransfrom?" cardBox-focustransform cardBox-withfocuscontent":" cardBox-withfocuscontent-large",options.cardLayout&&(cardBoxClass+=" card-focuscontent",enableFocusTransfrom||(cardBoxClass+=" card-focuscontent-large")));var logoUrl,progressHtml=indicators.getProgressBarHtml(item),innerCardFooter="",footerOverlayed=!1;options.showChannelLogo&&item.ChannelPrimaryImageTag?logoUrl=apiClient.getScaledImageUrl(item.ChannelId,{type:"Primary",height:40,tag:item.ChannelPrimaryImageTag}):options.showLogo&&item.ParentLogoImageTag&&(logoUrl=apiClient.getScaledImageUrl(item.ParentLogoItemId,{type:"Logo",height:40,tag:item.ParentLogoImageTag})),overlayText?(innerCardFooter+=getCardFooterText(item,0,options,showTitle,forceName,overlayText,imgUrl,footerCssClass=progressHtml?"innerCardFooter fullInnerCardFooter":"innerCardFooter",progressHtml,logoUrl=null,!1),footerOverlayed=!0):progressHtml&&(innerCardFooter+='<div class="innerCardFooter fullInnerCardFooter innerCardFooterClear">',innerCardFooter+=progressHtml,innerCardFooter+="</div>",progressHtml="");var outerCardFooter="";overlayText||footerOverlayed||(footerCssClass=options.cardLayout?"cardFooter":"cardFooter cardFooter-transparent",logoUrl&&(footerCssClass+=" cardFooter-withlogo"),options.cardLayout||(logoUrl=null),outerCardFooter=getCardFooterText(item,0,options,showTitle,forceName,overlayText,imgUrl,footerCssClass,progressHtml,logoUrl,!0)),outerCardFooter&&!options.cardLayout&&(cardBoxClass+=" cardBox-bottompadded");var cardImageContainerOpen,overlayButtons="";layoutManager.mobile&&options.centerPlayButton&&(overlayButtons+='<button is="paper-icon-button-light" class="cardOverlayButton itemAction cardOverlayFab-primary" data-action="'+(item.IsFolder?"resume":options.playAction||"play")+'"><i class="md-icon cardOverlayButtonIcon">&#xE037;</i></button>');options.showChildCountIndicator&&item.ChildCount&&(className+=" groupedCard");var cardImageContainerClose="",cardContentClass="cardContent";options.cardLayout||(cardContentClass+=" cardContent-shadow"),cardImageContainerClose=isLayoutTv?(cardImageContainerOpen=imgUrl?'<div class="'+cardImageContainerClass+" "+cardContentClass+' lazy" loading="lazy" style="background-image:url('+imgUrl+');">':'<div class="'+cardImageContainerClass+" "+cardContentClass+'">',"</div>"):(options.centerPlayButton||(className+=" card-touchzoom"),cardImageContainerOpen=imgUrl?'<button data-action="'+action+'" class="lazy itemAction cardContent-button '+cardImageContainerClass+" "+cardContentClass+'" loading="lazy" itemAction" style="background-image:url('+imgUrl+');">':'<button data-action="'+action+'" class="cardContent-button '+cardImageContainerClass+" "+cardContentClass+' itemAction">',"</button>");var cardScalableClass="cardScalable";isLayoutTv&&!options.cardLayout&&(cardScalableClass+=" card-focuscontent",enableFocusTransfrom||(cardScalableClass+=" card-focuscontent-large")),cardImageContainerOpen='<div class="'+cardBoxClass+'"><div class="'+cardScalableClass+'"><div class="cardPadder-'+shape+'"></div>'+cardImageContainerOpen,cardImageContainerOpen+=indicators.getTypeIndicator(item);var indicatorsHtml="";(!1!==options.missingIndicator&&(indicatorsHtml+=indicators.getMissingIndicator(item)),indicatorsHtml+=indicators.getSyncIndicator(item),indicatorsHtml+=indicators.getTimerIndicator(item),indicatorsHtml+=indicators.getPlayedIndicatorHtml(item),"CollectionFolder"===itemType||item.CollectionType)?(indicatorsHtml+='<div is="emby-itemrefreshindicator"'+(item.RefreshProgress?"":' class="hide"')+' data-progress="'+(item.RefreshProgress||0)+'" data-status="'+item.RefreshStatus+'"></div>',refreshIndicatorLoaded||(refreshIndicatorLoaded=!0,require(["emby-itemrefreshindicator"]))):"User"===itemType&&item.ConnectLinkType&&(indicatorsHtml+='<div title="'+globalize.translate("LinkedToEmbyConnect")+'" class="playedIndicator indicator"><i class="md-icon indicatorIcon">cloud</i></div>');indicatorsHtml&&(cardImageContainerOpen+='<div class="cardIndicators">'+indicatorsHtml+"</div>"),imgUrl||(cardImageContainerOpen+=function(item,options){var icon=getDefaultIcon(item,options.defaultCardImageIcon||!1);if(icon)return'<i class="cardImageIcon md-icon">'+icon+"</i>";return'<div class="cardText cardDefaultText">'+(isUsingLiveTvNaming(item.Type)?item.Name:itemHelper.getDisplayName(item))+"</div>"}(item,options));var tagName=isLayoutTv&&!overlayButtons?"button":"div",nameWithPrefix=item.SortName||item.Name||"",prefix=nameWithPrefix.substring(0,Math.min(3,nameWithPrefix.length));prefix=prefix&&prefix.toUpperCase();var actionAttribute,timerAttributes="";item.TimerId&&(timerAttributes+=' data-timerid="'+item.TimerId+'"'),item.SeriesTimerId&&(timerAttributes+=' data-seriestimerid="'+item.SeriesTimerId+'"'),actionAttribute="button"==tagName?(className+=" itemAction",' data-action="'+action+'"'):"","MusicAlbum"!==itemType&&"MusicArtist"!==itemType&&"Audio"!==itemType&&(className+=" card-withuserdata");var dataAttributes="";!1===options.multiSelect&&(dataAttributes+=' data-multiselect="false"'),options.context&&(dataAttributes+=' data-context="'+options.context+'"'),options.parentId&&(dataAttributes+=' data-parentid="'+options.parentId+'"'),item.StartPositionTicks&&(dataAttributes+=' data-startpositionticks="'+item.StartPositionTicks+'"'),item.ConfigPageUrl&&(dataAttributes+=' data-configpageurl="'+item.ConfigPageUrl+'"'),item.ChannelId&&(dataAttributes+=' data-channelid="'+item.ChannelId+'"'),item.CollectionType&&(dataAttributes+=' data-collectiontype="'+item.CollectionType+'"'),item.MediaType&&(dataAttributes+=' data-mediatype="'+item.MediaType+'"'),options.collectionId?dataAttributes+=' data-collectionid="'+options.collectionId+'"':options.playlistId&&(dataAttributes+=' data-playlistid="'+options.playlistId+'"');var additionalCardContent="";return layoutManager.desktop&&(additionalCardContent+=function(item,action,options){var html="";html+='<div class="cardOverlayContainer itemAction" data-action="'+action+'">';var btnCssClass="cardOverlayButton cardOverlayButton-hover itemAction",serverId=item.ServerId||options.serverId,itemType=item.Type,itemId=item.Id;!1!==options.multiSelect&&(html+='<label data-action="multiselect" data-id="'+itemId+'" data-serverid="'+serverId+'"  class="chkCardSelectContainer cardOverlayButton cardOverlayButton-hover itemAction"><input class="chkCardSelect" is="emby-checkbox" type="checkbox" data-focushelper="false" /></label>');if(playbackManager.canPlay(item)&&!1!==options.hoverPlayButton){var playButtonAction=item.IsFolder?"resume":options.playAction||"play";html+='<button is="paper-icon-button-light" class="'+btnCssClass+' cardOverlayFab-primary" data-action="'+playButtonAction+'"><i class="md-icon cardOverlayButtonIcon">&#xE037;</i></button>'}html+='<div class="cardOverlayButton-br">';var userData=item.UserData||{};!1!==options.playedButton&&itemHelper.canMarkPlayed(item)&&(html+='<button is="emby-playstatebutton" type="button" data-action="none" class="'+btnCssClass+'" data-id="'+itemId+'" data-serverid="'+serverId+'" data-itemtype="'+itemType+'" data-played="'+userData.Played+'"><i class="md-icon cardOverlayButtonIcon cardOverlayButtonIcon-hover">&#xE5CA;</i></button>');if(!1!==options.ratingButton&&itemHelper.canRate(item)){var likes=null==userData.Likes?"":userData.Likes;html+='<button is="emby-ratingbutton" type="button" data-action="none" class="'+btnCssClass+'" data-id="'+itemId+'" data-serverid="'+serverId+'" data-itemtype="'+itemType+'" data-likes="'+likes+'" data-isfavorite="'+userData.IsFavorite+'"><i class="md-icon cardOverlayButtonIcon cardOverlayButtonIcon-hover">&#xE87D;</i></button>'}!1!==options.moreButton&&"Program"!==item.Type&&(html+='<button is="paper-icon-button-light" class="'+btnCssClass+'" data-action="menu"><i class="md-icon cardOverlayButtonIcon cardOverlayButtonIcon-hover">&#xE5D3;</i></button>');return html+="</div>",html+="</div>"}(item,action,options)),"<"+tagName+' data-index="'+index+'"'+timerAttributes+actionAttribute+' data-isfolder="'+(item.IsFolder||!1)+'" data-serverid="'+(item.ServerId||options.serverId)+'" data-id="'+(item.Id||item.ItemId)+'" data-type="'+itemType+'"'+dataAttributes+' data-prefix="'+prefix+'" class="'+className+'">'+cardImageContainerOpen+innerCardFooter+cardImageContainerClose+overlayButtons+additionalCardContent+"</div>"+outerCardFooter+"</div></"+tagName+">"}function getDefaultIcon(item,defaultIcon){switch(item.CollectionType){case"movies":return"&#xE54D;";case"music":return"&#xE310;";case"homevideos":case"photos":return"&#xE412;";case"livetv":case"tvshows":return"&#xE639;";case"games":return"&#xe30f;";case"trailers":return"&#xE54D;";case"musicvideos":return"&#xE04A;";case"books":case"channels":return"&#xE2C7;";case"playlists":return"&#xE5D2;"}var itemType=item.Type;return"MusicAlbum"===itemType?"&#xE019;":"MusicArtist"===itemType||"Person"===itemType?"&#xE7FD;":"Channel"===itemType?"&#xE2C7;":"Device"===itemType?"devices":"User"===itemType?"person":!1===defaultIcon?null:"string"==typeof defaultIcon?defaultIcon:"&#xE2C7;"}function ensureIndicators(card,indicatorsElem){if(indicatorsElem)return indicatorsElem;if(!(indicatorsElem=card.querySelector(".cardIndicators"))){var cardImageContainer=card.querySelector(".cardImageContainer");(indicatorsElem=document.createElement("div")).classList.add("cardIndicators"),cardImageContainer.appendChild(indicatorsElem)}return indicatorsElem}function updateUserData(card,userData){var type=card.getAttribute("data-type"),enableCountIndicator="Series"===type||"BoxSet"===type||"Season"===type,indicatorsElem=null,playedIndicator=null,countIndicator=null,itemProgressBar=null;userData.Played?((playedIndicator=card.querySelector(".playedIndicator"))||((playedIndicator=document.createElement("div")).classList.add("playedIndicator"),playedIndicator.classList.add("indicator"),(indicatorsElem=ensureIndicators(card,indicatorsElem)).appendChild(playedIndicator)),playedIndicator.innerHTML='<i class="md-icon indicatorIcon">&#xE5CA;</i>'):(playedIndicator=card.querySelector(".playedIndicator"))&&playedIndicator.parentNode.removeChild(playedIndicator),userData.UnplayedItemCount?((countIndicator=card.querySelector(".countIndicator"))||((countIndicator=document.createElement("div")).classList.add("countIndicator"),(indicatorsElem=ensureIndicators(card,indicatorsElem)).appendChild(countIndicator)),countIndicator.innerHTML=userData.UnplayedItemCount):enableCountIndicator&&(countIndicator=card.querySelector(".countIndicator"))&&countIndicator.parentNode.removeChild(countIndicator);var progressHtml=indicators.getProgressBarHtml({Type:type,UserData:userData,MediaType:"Video"});if(progressHtml){if(!(itemProgressBar=card.querySelector(".itemProgressBar"))){(itemProgressBar=document.createElement("div")).classList.add("itemProgressBar");var innerCardFooter=card.querySelector(".innerCardFooter");if(!innerCardFooter)(innerCardFooter=document.createElement("div")).classList.add("innerCardFooter"),card.querySelector(".cardImageContainer").appendChild(innerCardFooter);innerCardFooter.appendChild(itemProgressBar)}itemProgressBar.innerHTML=progressHtml}else(itemProgressBar=card.querySelector(".itemProgressBar"))&&itemProgressBar.parentNode.removeChild(itemProgressBar)}return{getCardsHtml:function(items,options){return 1===arguments.length&&(items=(options=arguments[0]).items),buildCardsHtmlInternal(items,options)},buildCards:function(items,options){if(document.body.contains(options.itemsContainer)){if(options.parentContainer){if(!items.length)return void options.parentContainer.classList.add("hide");options.parentContainer.classList.remove("hide")}var html=buildCardsHtmlInternal(items,options);html?(options.itemsContainer.cardBuilderHtml!==html&&(options.itemsContainer.innerHTML=html,items.length<50?options.itemsContainer.cardBuilderHtml=html:options.itemsContainer.cardBuilderHtml=null),imageLoader.lazyChildren(options.itemsContainer)):(options.itemsContainer.innerHTML=html,options.itemsContainer.cardBuilderHtml=null),options.autoFocus&&focusManager.autoFocus(options.itemsContainer,!0)}},onUserDataChanged:function(userData,scope){for(var cards=(scope||document.body).querySelectorAll('.card-withuserdata[data-id="'+userData.ItemId+'"]'),i=0,length=cards.length;i<length;i++)updateUserData(cards[i],userData)},onTimerCreated:function(programId,newTimerId,itemsContainer){for(var cells=itemsContainer.querySelectorAll('.card[data-id="'+programId+'"]'),i=0,length=cells.length;i<length;i++){var cell=cells[i];if(!cell.querySelector(".timerIndicator"))ensureIndicators(cell).insertAdjacentHTML("beforeend",'<i class="md-icon timerIndicator indicatorIcon">&#xE061;</i>');cell.setAttribute("data-timerid",newTimerId)}},onTimerCancelled:function(id,itemsContainer){for(var cells=itemsContainer.querySelectorAll('.card[data-timerid="'+id+'"]'),i=0,length=cells.length;i<length;i++){var cell=cells[i],icon=cell.querySelector(".timerIndicator");icon&&icon.parentNode.removeChild(icon),cell.removeAttribute("data-timerid")}},onSeriesTimerCancelled:function(id,itemsContainer){for(var cells=itemsContainer.querySelectorAll('.card[data-seriestimerid="'+id+'"]'),i=0,length=cells.length;i<length;i++){var cell=cells[i],icon=cell.querySelector(".timerIndicator");icon&&icon.parentNode.removeChild(icon),cell.removeAttribute("data-seriestimerid")}},getDefaultIcon:getDefaultIcon}});